<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini-Sandbox</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121821; --panel-2:#0f141b; --text:#e6eef7; --muted:#8aa0b2; --accent:#4fc3f7; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,var(--bg),#0a0d12); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .app{display:grid; grid-template-columns:1fr 280px; gap:12px; height:100vh; padding:12px}
    .board{
      position:relative; display:grid; place-items:center; background:radial-gradient(1200px 600px at 50% -200px, rgba(79,195,247,.08), transparent), var(--panel);
      border-radius:14px; box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
    }
    canvas{image-rendering: pixelated; image-rendering: crisp-edges; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.35)}

    .sidebar{background:var(--panel); border-radius:14px; padding:12px; display:flex; flex-direction:column; gap:12px; box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.05); background:var(--panel-2); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:inset 0 1px 0 rgba(255,255,255,.04);}
    .btn:hover{filter:brightness(1.07)}
    .btn.active{outline:2px solid var(--accent)}
    .title{font-weight:800; letter-spacing:.2px}
    .tools{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .color-dot{width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle;}
    .muted{color:var(--muted); font-size:12px}
    .range{width:100%}
    .footer{margin-top:auto; font-size:12px; color:var(--muted); text-align:center}
    .danger{background:linear-gradient(180deg,#2a0d12,#1a0a0d); border:1px solid rgba(255,107,107,.25)}
  </style>
</head>
<body>
  <div class="app">
    <div class="board">
      <canvas id="world" width="320" height="200"></canvas>
    </div>
    <aside class="sidebar">
      <div>
        <div class="title">Elemente</div>
        <div class="tools" id="palette"></div>
      </div>

      <div>
        <div class="title">Pinsel</div>
        <label class="row" style="align-items:center; gap:10px">
          Gr√∂√üe
          <input id="brush" type="range" min="1" max="10" value="3" class="range"/>
          <span id="brushVal" class="muted">3</span>
        </label>
      </div>

      <div>
        <div class="title">Steuerung</div>
        <div class="row">
          <button class="btn" id="pauseBtn">‚èØÔ∏è Pause</button>
          <button class="btn" id="stepBtn">‚ñ∂Ô∏è Einzelschritt</button>
          <button class="btn" id="clearBtn">üßπ Leeren</button>
          <button class="btn danger" id="boomBtn">üí• Nuke z√ºnden</button>
        </div>
        <div class="muted">Tipp: Linksklick malt, Rechtsklick l√∂scht</div>
      </div>

      <div class="footer">Mini‚ÄëSandbox ¬∑ HTML5 Canvas ¬∑ v1.0</div>
    </aside>
  </div>

  <script>
    // === Einstellungen ===
    const W = 480;          // interner Pixel‚ÄëRaster (Breite)
    const H = 300;          // interner Pixel‚ÄëRaster (H√∂he)
    const SCALE = 2;        // Canvas wird hochskaliert (160x100 -> 320x200)
    const TICK_MS = 16;     // ca. 60 FPS

    // === Canvas/Rendering ===
    const canvas = document.getElementById('world');
    const ctx = canvas.getContext('2d');
    canvas.width = W * SCALE;
    canvas.height = H * SCALE;

    // Backing store als ImageData
    const screen = ctx.createImageData(W, H);
    const pix = screen.data; // Uint8ClampedArray

    // === Zellen/Elemente ===
    const AIR=0, SAND=1, WATER=2, COAL=3, FIRE=4, LAVA=5, NUKE=6;

    const Elements = {
      [AIR]:  {name:'L√∂schen', color:[0,0,0,0]},
      [SAND]: {name:'Sand', color:[229,197,94,255], density:3, granular:true},
      [WATER]:{name:'Wasser', color:[90,140,255,255], density:1, liquid:true},
      [COAL]: {name:'Kohle', color:[45,50,55,255], solid:true, fuel:true, hp:8},
      [FIRE]: {name:'Feuer', color:[255,120,30,200], gas:true, life:10},
      [LAVA]: {name:'Lava', color:[255,80,20,255], density:2, liquid:true, hot:true},
      [NUKE]: {name:'Nuke', color:[130,255,130,255], solid:true}
    };

    // Weltzustand
    const world = new Uint8Array(W*H).fill(0);  // speichert Typ je Zelle
    const aux1  = new Uint8Array(W*H).fill(0);  // z.B. Lebensdauer/HP
    const aux2  = new Uint8Array(W*H).fill(0);  // z.B. K√ºhlung etc.

    // Helfer: Index und (x,y)
    const idx = (x,y)=> y*W + x;

    // Zufall
    const rnd = (n)=> Math.floor(Math.random()*n);

    // Palette/Buttons
    const palette = [SAND,WATER,COAL,FIRE,LAVA,NUKE];
    let current = SAND;

    const palEl = document.getElementById('palette');
    function makeBtn(type){
      const b = document.createElement('button');
      b.className='btn';
      const c = Elements[type].color; const dot = `<span class="color-dot" style="background:rgba(${c[0]},${c[1]},${c[2]},${(c[3]||255)/255})"></span>`;
      b.innerHTML = `${dot}${Elements[type].name}`;
      b.addEventListener('click',()=>{ current=type; document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); });
      return b;
    }
    palette.forEach((t,i)=>{ const b = makeBtn(t); if(i===0) b.classList.add('active'); palEl.appendChild(b); });

    // Pinsel
    const brush = document.getElementById('brush');
    const brushVal = document.getElementById('brushVal');
    brush.addEventListener('input',()=> brushVal.textContent = brush.value);

    // Steuerung
    let paused=false; let stepOnce=false;
    document.getElementById('pauseBtn').onclick=()=> paused=!paused;
    document.getElementById('stepBtn').onclick=()=> { stepOnce=true; paused=false; };
    document.getElementById('clearBtn').onclick=()=> { world.fill(0); aux1.fill(0); aux2.fill(0); };

    // Nuke: Globale Z√ºndung (Schockwelle + Feuerball)
    document.getElementById('boomBtn').onclick=()=>{
      // Suche alle Nuke‚ÄëZellen und z√ºnde sie
      for(let y=0;y<H;y++) for(let x=0;x<W;x++){
        if(world[idx(x,y)]===NUKE){ explode(x,y,14); world[idx(x,y)]=AIR; }
      }
    };

    // Maus Interaktion
    let mouseDown=false; let rightDown=false; let mouseX=0, mouseY=0;
    canvas.addEventListener('contextmenu', e=> e.preventDefault());
    canvas.addEventListener('mousedown', e=>{ mouseDown=true; rightDown = (e.button===2); drawAt(e); });
    window.addEventListener('mouseup', ()=> mouseDown=false);
    canvas.addEventListener('mousemove', e=>{ if(mouseDown) drawAt(e); });

    function drawAt(e){
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left)/SCALE);
      const y = Math.floor((e.clientY - rect.top)/SCALE);
      mouseX=x; mouseY=y;
      const r = parseInt(brush.value);
      const type = rightDown ? AIR : current;
      for(let j=-r;j<=r;j++) for(let i=-r;i<=r;i++){
        const xx=x+i, yy=y+j; if(xx<0||yy<0||xx>=W||yy>=H) continue;
        if(i*i+j*j <= r*r){
          world[idx(xx,yy)] = type;
          if(type===FIRE) aux1[idx(xx,yy)] = 8 + rnd(6); // Lebensdauer
          if(type===COAL) aux1[idx(xx,yy)] = Elements[COAL].hp;
        }
      }
    }

    // Physik/Simulation
    function swap(a,b){ const t=world[a]; world[a]=world[b]; world[b]=t; const t1=aux1[a]; aux1[a]=aux1[b]; aux1[b]=t1; const t2=aux2[a]; aux2[a]=aux2[b]; aux2[b]=t2; }

    function inBounds(x,y){ return x>=0&&y>=0&&x<W&&y<H; }

    function isEmpty(x,y){ return inBounds(x,y) && world[idx(x,y)]===AIR; }

    function tryFall(x,y){
      const i = idx(x,y);
      // Down
      if(y+1<H){
        const d = idx(x,y+1);
        if(world[d]===AIR || (Elements[world[i]].density||0) > (Elements[world[d]].density||99)) { swap(i,d); return true; }
      }
      // Down-left/right (randomized)
      const dir = Math.random()<.5? -1: 1;
      for(let s of [dir, -dir]){
        const nx=x+s, ny=y+1; if(!inBounds(nx,ny)) continue;
        const d = idx(nx,ny);
        if(world[d]===AIR || (Elements[world[i]].density||0) > (Elements[world[d]].density||99)) { swap(i,d); return true; }
      }
      return false;
    }

    function tryFlow(x,y){
      const i = idx(x,y);
      // try fall like a liquid
      if(tryFall(x,y)) return true;
      // horizontal spread
      const dir = Math.random()<.5? -1: 1;
      for(let s of [dir, -dir]){
        const nx=x+s, ny=y; if(!inBounds(nx,ny)) continue;
        const d = idx(nx,ny);
        if(world[d]===AIR) { swap(i,d); return true; }
      }
      return false;
    }

    function ignite(x,y,heat=1){
      if(!inBounds(x,y)) return;
      const t = world[idx(x,y)];
      if(t===COAL){ world[idx(x,y)]=FIRE; aux1[idx(x,y)] = 10 + rnd(10); }
      if(t===WATER && heat>1){ // Wasser verdampft -> kurz Feuerfunken
        world[idx(x,y)]=FIRE; aux1[idx(x,y)] = 2 + rnd(2);
      }
    }

    function coolWaterNear(x,y){
      for(let j=-1;j<=1;j++) for(let i=-1;i<=1;i++){
        const xx=x+i, yy=y+j; if(!inBounds(xx,yy)) continue;
        if(world[idx(xx,yy)]===WATER && Math.random()<0.2){ world[idx(xx,yy)]=AIR; }
      }
    }

    function explode(cx,cy,r){
      const r2 = r*r;
      for(let y=cy-r;y<=cy+r;y++) for(let x=cx-r;x<=cx+r;x++){
        if(!inBounds(x,y)) continue;
        const d2 = (x-cx)*(x-cx)+(y-cy)*(y-cy);
        if(d2<=r2){
          if(Math.random()<0.85) world[idx(x,y)] = AIR; // Druckwelle r√§umt frei
          if(Math.random()<0.45) { world[idx(x,y)] = FIRE; aux1[idx(x,y)] = 6 + rnd(6); }
        }else if(d2<=r2*1.4 && Math.random()<0.25){
          world[idx(x,y)] = FIRE; aux1[idx(x,y)] = 4 + rnd(6);
        }
      }
    }

    function step(){
      // Update‚ÄëReihenfolge von unten nach oben, damit Dinge nach unten fallen k√∂nnen
      for(let y=H-1;y>=0;y--){
        for(let x=0;x<W;x++){
          const i = idx(x,y);
          const t = world[i];
          if(t===AIR) continue;

          if(t===SAND){
            tryFall(x,y);
          }
          else if(t===WATER){
            tryFlow(x,y);
          }
          else if(t===LAVA){
            // Lava flie√üt langsam und erhitzt Umgebung
            if(Math.random()<0.6) tryFlow(x,y);
            // entz√ºnde Brennbares / verdampfe Wasser
            for(let j=-1;j<=1;j++) for(let k=-1;k<=1;k++) if(j||k){ ignite(x+k,y+j,2); }
            if(Math.random()<0.01) world[i]=SAND; // Lava k√ºhlt zu Sand ab
          }
          else if(t===COAL){
            // brennt wenn Nachbar Feuer/Lava
            let nearFire=false;
            for(let j=-1;j<=1;j++) for(let k=-1;k<=1;k++) if(j||k){ const n=idx(x+k,y+j); if(inBounds(x+k,y+j) && (world[n]===FIRE || world[n]===LAVA)) nearFire=true; }
            if(nearFire && Math.random()<0.3){ world[i]=FIRE; aux1[i]= 18 + rnd(12); }
          }
          else if(t===FIRE){
            // Lebensdauer
            if(aux1[i]>0) aux1[i]--; else { world[i]=AIR; continue; }
            // steigt leicht nach oben
            const up = y>0 && (world[idx(x,y-1)]===AIR);
            if(up && Math.random()<0.5) { swap(i, idx(x,y-1)); continue; }
            // verbreitet sich
            const kx = x + (Math.random()<.5? -1:1);
            const ky = y + (Math.random()<.5? -1:1);
            ignite(kx,ky,1);
          }
          else if(t===NUKE){
            // Ber√ºhrung mit Feuer/Lava z√ºndet sofort
            let hot=false;
            for(let j=-1;j<=1;j++) for(let k=-1;k<=1;k++) if(j||k){ const xx=x+k, yy=y+j; if(inBounds(xx,yy)){ const nt=world[idx(xx,yy)]; if(nt===FIRE||nt===LAVA) hot=true; }}
            if(hot){ explode(x,y,14); world[i]=AIR; }
          }
        }
      }
    }

    // Rendern
    function draw(){
      for(let y=0;y<H;y++){
        for(let x=0;x<W;x++){
          const t = world[idx(x,y)];
          let [r,g,b,a] = Elements[t].color || [0,0,0,0];
          // kleine Variation f√ºr Sand/Lava/Feuer f√ºr Look
          if(t===SAND){ r+=rnd(12)-6; g+=rnd(12)-6; }
          if(t===LAVA){ r+=rnd(10)-5; b+=rnd(6)-3; }
          if(t===FIRE){ r=255; g=120+rnd(80); b=rnd(40); a=150+rnd(80); }
          r=Math.max(0,Math.min(255,r)); g=Math.max(0,Math.min(255,g)); b=Math.max(0,Math.min(255,b));
          const p = (y*W + x)*4;
          pix[p]=r; pix[p+1]=g; pix[p+2]=b; pix[p+3]=a;
        }
      }
      // Skaliert zeichnen
      ctx.putImageData(screen,0,0);
      ctx.save();
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(canvas,0,0,W,H,0,0,W*SCALE,H*SCALE);
      ctx.restore();
    }

    // Game Loop
    function loop(){
      if(!paused || stepOnce){ step(); stepOnce=false; }
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
